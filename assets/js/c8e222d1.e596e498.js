/*! For license information please see c8e222d1.e596e498.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[480198],{556555:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>d});var i=t(474848),r=t(28453);const s={id:"oidc",title:"OIDC provider from scratch",description:"This section shows how to enable and use the Backstage OIDC provider."},a=void 0,o={id:"auth/oidc",title:"OIDC provider from scratch",description:"This section shows how to enable and use the Backstage OIDC provider.",source:"@site/../docs/auth/oidc.md",sourceDirName:"auth",slug:"/auth/oidc",permalink:"/docs/next/auth/oidc",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/auth/oidc.md",tags:[],version:"current",frontMatter:{id:"oidc",title:"OIDC provider from scratch",description:"This section shows how to enable and use the Backstage OIDC provider."},sidebar:"docs",previous:{title:"OAuth and OpenID Connect",permalink:"/docs/next/auth/oauth"},next:{title:"Contributing New Provider Modules",permalink:"/docs/next/auth/add-auth-provider"}},c={},d=[{value:"Summary",id:"summary",level:2},{value:"Steps",id:"steps",level:2},{value:"The API Reference",id:"the-api-reference",level:3},{value:"The API Factory (and auth provider)",id:"the-api-factory-and-auth-provider",level:3},{value:"The Resolver",id:"the-resolver",level:3},{value:"The Configuration",id:"the-configuration",level:3},{value:"Required Parameters",id:"required-parameters",level:4},{value:"Optional Parameters",id:"optional-parameters",level:4},{value:"The Sign-In Page",id:"the-sign-in-page",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["This documentation is written for ",(0,i.jsx)(n.a,{href:"/docs/next/backend-system/",children:"the new backend system"})," which is the default since Backstage\n",(0,i.jsx)(n.a,{href:"/docs/next/releases/v1.24.0",children:"version 1.24"}),". If you are still on the old backend\nsystem, you may want to read ",(0,i.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/v1.37.0/docs/auth/oidc--old.md",children:"its own article"}),"\ninstead, and ",(0,i.jsx)(n.a,{href:"/docs/next/backend-system/building-backends/migrating",children:"consider migrating"}),"!"]})}),"\n",(0,i.jsx)(n.p,{children:"This section shows how to enable and use the Backstage OIDC provider."}),"\n",(0,i.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,i.jsxs)(n.p,{children:["OIDC is a protocol which has numerous implementations. It's likely that many of your users won't know what the OIDC ",(0,i.jsx)(n.strong,{children:"protocol"})," is, but they will recognise your OIDC ",(0,i.jsx)(n.strong,{children:"implementation"}),". Backstage supplies a generic ",(0,i.jsx)(n.code,{children:"oidc"})," authorization strategy. You should re-badge this with the name and branding of your OIDC implementation, so that your users will recognise it on the Backstage sign-in page."]}),"\n",(0,i.jsxs)(n.p,{children:["For example, if your organization uses ",(0,i.jsx)(n.a,{href:"https://www.keycloak.org",children:"Keycloak"}),", you would re-badge the OIDC provider as ",(0,i.jsx)(n.code,{children:"Keycloak"})," and tell users to ",(0,i.jsx)(n.code,{children:"Sign In using Keycloak"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"steps",children:"Steps"}),"\n",(0,i.jsx)(n.p,{children:"The Backstage OIDC provider is not enabled by default. You need to manually enable the provider, and tell it which OIDC server you want to use."}),"\n",(0,i.jsx)(n.p,{children:"To enable the Backstage OIDC provider:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Create an API reference to identify the provider."}),"\n",(0,i.jsx)(n.li,{children:"Create the API factory that will handle the authentication."}),"\n",(0,i.jsx)(n.li,{children:"Add or reuse an auth provider so you can authenticate."}),"\n",(0,i.jsx)(n.li,{children:"Add or reuse a resolver to handle the result from the authentication."}),"\n",(0,i.jsx)(n.li,{children:"Configure the provider to access your 3rd party auth solution."}),"\n",(0,i.jsx)(n.li,{children:"Add the provider to the Backstage sign-in page."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"For simplicity, we assume that you only have a single OIDC provider in your Backstage installation. (If you need to have multiple OIDC providers in Backstage, the steps will be different.)"}),"\n",(0,i.jsx)(n.p,{children:"We'll explain each step more in detail next."}),"\n",(0,i.jsx)(n.h3,{id:"the-api-reference",children:"The API Reference"}),"\n",(0,i.jsxs)(n.p,{children:["An API reference exists to enable ",(0,i.jsx)(n.strong,{children:"Dependency Injection"}),". (See ",(0,i.jsx)(n.a,{href:"https://backstage.io/docs/api/utility-apis",children:"Utility APIs"})," for an extended explanation.)"]}),"\n",(0,i.jsxs)(n.p,{children:["In this example, we'll create the API ref directly in the ",(0,i.jsx)(n.code,{children:"packages/app/src/apis.ts"})," file. It is not a requirement to put the ref in this file. Any location will do as long as it's available to be imported to where the API factory is, as well as easily accessible to the rest of the application so any package and plugin can inject the API instance when necessary."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export const keycloakAuthApiRef: ApiRef<\n  OpenIdConnectApi & ProfileInfoApi & BackstageIdentityApi & SessionApi\n> = createApiRef({\n  id: 'auth.keycloak',\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"id"})," of the API ref can be anything you want, as long as it doesn't conflict with other refs. Backstage recommends to use a custom name that references your custom provider."]}),"\n",(0,i.jsxs)(n.admonition,{title:"TypeScript Note",type:"note",children:[(0,i.jsx)(n.p,{children:"As we're exporting this API reference, as well as the TypeScript types, we need to\nbe able to import this reference anywhere in the app. The types will tell TypeScript\nwhat instance we're getting from DI when injecting the API. In this case we are defining\nan API for authentication, so we tell TS that this instance complies with 4 API\ninterfaces:"}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The OIDC API that will handle authentication."}),"\n",(0,i.jsx)(n.li,{children:"Profile API for requesting user profile info from the auth provider in question."}),"\n",(0,i.jsx)(n.li,{children:"Backstage identity API to handle and associate the user profile with backstage identity."}),"\n",(0,i.jsx)(n.li,{children:"Session API, to handle the session the user will have while signed in."}),"\n"]})]}),"\n",(0,i.jsx)(n.h3,{id:"the-api-factory-and-auth-provider",children:"The API Factory (and auth provider)"}),"\n",(0,i.jsx)(n.p,{children:"The Backstage API factories are part of the Backstage Dependency Injection system. The factory function runs once, when something in your Backstage app first attempts to use an instance of the API it provides. The instance is then cached by the DI system for subsequent lookups."}),"\n",(0,i.jsxs)(n.p,{children:["Let's add a new API factory to the ",(0,i.jsx)(n.code,{children:"apis"})," array in the ",(0,i.jsx)(n.code,{children:"packages/app/src/apis.ts"})," file. We will tell it to use the OIDC auth provider internally."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/app/src/apis.ts"',children:"/* highlight-add-next-line */\nimport { OAuth2 } from '@backstage/core-app-api';\n\nexport const apis: AnyApiFactory[] = [\n  /* highlight-add-start */\n  createApiFactory({\n    api: keycloakAuthApiRef,\n    deps: {\n      discoveryApi: discoveryApiRef,\n      oauthRequestApi: oauthRequestApiRef,\n      configApi: configApiRef,\n    },\n    factory: ({ discoveryApi, oauthRequestApi, configApi }) =>\n      // delegate auth to the OAuth2 strategy\n      OAuth2.create({\n        configApi,\n        discoveryApi,\n        oauthRequestApi,\n        provider: {\n          // this value MUST be 'oidc'\n          // it maps our Keycloak-branded sign-in provider onto Backstage's generic OIDC auth strategy\n          id: 'oidc',\n          title: 'Keycloak',\n          icon: () => null,\n        },\n        environment: configApi.getOptionalString('auth.environment'),\n        defaultScopes: ['openid', 'profile', 'email'],\n        popupOptions: {\n          // optional, used to customize sign-in window size\n          size: {\n            fullscreen: true,\n          },\n          /**\n           * or specify popup width and height\n           * size: {\n              width: 1000,\n              height: 1000,\n            }\n           */\n        },\n      }),\n  }),\n  /* highlight-add-end */\n];\n"})}),"\n",(0,i.jsx)(n.h3,{id:"the-resolver",children:"The Resolver"}),"\n",(0,i.jsx)(n.p,{children:"Resolvers exist to map the user identity from the 3rd party (in this case Keycloak) to the Backstage user identity."}),"\n",(0,i.jsx)(n.p,{children:"The default OIDC provider has a choice of built-in resolvers, here is how you configure them:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="app-config.yaml"',children:"auth:\n  environment: development\n  providers:\n    oidc:\n      development:\n        # ...\n        signIn:\n          resolvers:\n            - resolver: emailMatchingUserEntityProfileEmail\n"})}),"\n",(0,i.jsx)(n.p,{children:"If none of the built-in resolvers are suitable, you can alternatively write a custom resolver. See an example below:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="in packages/backend/src/index.ts"',children:"/* highlight-add-start */\nimport { createBackendModule } from '@backstage/backend-plugin-api';\nimport {\n  authProvidersExtensionPoint,\n  createOAuthProviderFactory,\n} from '@backstage/plugin-auth-node';\nimport { oidcAuthenticator } from '@backstage/plugin-auth-backend-module-oidc-provider';\n\nconst myAuthProviderModule = createBackendModule({\n  // This ID must be exactly \"auth\" because that's the plugin it targets\n  pluginId: 'auth',\n  // This ID must be unique, but can be anything\n  moduleId: 'keycloak-auth-provider',\n  register(reg) {\n    reg.registerInit({\n      deps: { providers: authProvidersExtensionPoint },\n      async init({ providers }) {\n        providers.registerProvider({\n          // This ID must match the actual provider config, e.g. addressing\n          // auth.providers.keycloak means that this must be \"keycloak\".\n          providerId: 'keycloak',\n          // Use createProxyAuthProviderFactory instead if it's one of the proxy\n          // based providers rather than an OAuth based one\n          factory: createOAuthProviderFactory({\n            // For more info about authenticators please see https://backstage.io/docs/auth/add-auth-provider/#adding-an-oauth-based-provider\n            authenticator: oidcAuthenticator,\n            async signInResolver(info, ctx) {\n              const userRef = stringifyEntityRef({\n                kind: 'User',\n                name: info.result.userinfo.sub,\n                namespace: DEFAULT_NAMESPACE,\n              });\n              return ctx.issueToken({\n                claims: {\n                  sub: userRef, // The user's own identity\n                  ent: [userRef], // A list of identities that the user claims ownership through\n                },\n              });\n            },\n          }),\n        });\n      },\n    });\n  },\n});\n/* highlight-add-end */\n//...\nbackend.add(import('@backstage/plugin-auth-backend'));\n/* highlight-add-next-line */\nbackend.add(myAuthProviderModule);\n//...\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For a more detailed explanation about resolvers check the ",(0,i.jsx)(n.a,{href:"https://backstage.io/docs/auth/identity-resolver",children:"Identity Resolver"})," page."]}),"\n",(0,i.jsx)(n.h3,{id:"the-configuration",children:"The Configuration"}),"\n",(0,i.jsx)(n.p,{children:"We will now configure our Keycloak-branded OIDC Auth Provider in Backstage, so that it can talk to our Keycloak server."}),"\n",(0,i.jsx)(n.p,{children:"The first step is to register an OIDC client app for Backstage in your Keycloak server."}),"\n",(0,i.jsxs)(n.p,{children:["Then we need to configure the provider. Based on the provider's code in ",(0,i.jsx)(n.code,{children:"plugins/auth-backend/src/providers/oidc/provider.ts"})," we need the following parameters in the ",(0,i.jsx)(n.code,{children:"app-config.yaml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="app-config.yaml"',children:"auth:\n  environment: development\n  session:\n    secret: ${AUTH_SESSION_SECRET}\n  providers:\n    oidc:\n      development:\n        metadataUrl: https://example.com/.well-known/openid-configuration\n        clientId: ${AUTH_OIDC_CLIENT_ID}\n        clientSecret: ${AUTH_OIDC_CLIENT_SECRET}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Anything enclosed in ",(0,i.jsx)(n.code,{children:"${}"})," can be replaced directly in the YAML, or provided as environment variables."]}),"\n",(0,i.jsx)(n.h4,{id:"required-parameters",children:"Required Parameters"}),"\n",(0,i.jsx)(n.p,{children:"These parameters must always be set."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"clientId"}),": Grab from the Overview page."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"clientSecret"}),": Can only be seen when creating the secret, if you lose it you'll need a\nnew secret."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"metadataUrl"}),": In Overview > Endpoints tab, grab OpenID Connect metadata document URL."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The OIDC provider ",(0,i.jsx)(n.strong,{children:"also"})," requires the ",(0,i.jsx)(n.code,{children:"auth.session.secret"})," to be set."]}),"\n",(0,i.jsx)(n.h4,{id:"optional-parameters",children:"Optional Parameters"}),"\n",(0,i.jsx)(n.p,{children:"These parameters have implicit default values. Don't override them unless you know what you're doing."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"authorizationUrl"})," and ",(0,i.jsx)(n.code,{children:"tokenUrl"}),": Open the ",(0,i.jsx)(n.code,{children:"metadataUrl"})," in a browser, that json will\nhold these 2 urls somewhere in there."]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"tokenEndpointAuthMethod"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"tokenSignedResponseAlg"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"scope"}),": Only used if we didn't specify ",(0,i.jsx)(n.code,{children:"defaultScopes"})," in the provider's factory,\nbasically the same thing."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"prompt"}),": Recommended to use ",(0,i.jsx)(n.code,{children:"auto"})," so the browser will request sign-in to the IDP if the\nuser has no active session."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sessionDuration"}),": Lifespan of the user session."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Config Reloading",type:"note",children:(0,i.jsx)(n.p,{children:"Backstage does not yet support hot reloading of auth provider configuration. Any changes to this YAML file require a restart of Backstage."})}),"\n",(0,i.jsx)(n.h3,{id:"the-sign-in-page",children:"The Sign-In Page"}),"\n",(0,i.jsx)(n.p,{children:"The last step is to add the provider to the sign-in page, so users can sign in with your new provider."}),"\n",(0,i.jsxs)(n.p,{children:["If you are using the standard Backstage ",(0,i.jsx)(n.a,{href:"https://backstage.io/docs/auth/#sign-in-configuration",children:(0,i.jsx)(n.code,{children:"SignInPage"})})," component, you can just add it to the ",(0,i.jsx)(n.code,{children:"providers"})," array like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="in packages/app/src/identityProviders.ts"',children:"export const providers = [\n  // other providers...\n  {\n    id: 'keycloak-auth-provider',\n    title: 'Keycloak',\n    message: 'Sign In using Keycloak',\n    apiRef: keycloakAuthApiRef,\n  },\n];\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"note",children:(0,i.jsx)(n.p,{children:"These steps apply to most auth providers. The main\ndifference between providers will be the contents of the API factory, the code\nin the Auth Provider Factory, the resolver, and the different variables each provider\nneeds in the YAML config or env variables."})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},221020:(e,n,t)=>{var i=t(296540),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,o=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function d(e,n,t){var i,s={},d=null,l=null;for(i in void 0!==t&&(d=""+t),void 0!==n.key&&(d=""+n.key),void 0!==n.ref&&(l=n.ref),n)a.call(n,i)&&!c.hasOwnProperty(i)&&(s[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps)void 0===s[i]&&(s[i]=n[i]);return{$$typeof:r,type:e,key:d,ref:l,props:s,_owner:o.current}}n.Fragment=s,n.jsx=d,n.jsxs=d},474848:(e,n,t)=>{e.exports=t(221020)},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var i=t(296540);const r={},s=i.createContext(r);function a(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);